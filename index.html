<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nixer Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json?v=v2" />
  <meta name="theme-color" content="#1976d2" />

  <link rel="stylesheet" href="style.css?v=v2" />
</head>

<body>
  <h1>Nixer Management</h1>

  <!-- ✅ AUTH (Login / Sign up) -->
  <div class="container" id="authContainer" style="max-width:560px; display:none;">
    <h2 style="margin-top:0;">Login / Sign up</h2>

    <label style="display:flex; flex-direction:column; gap:6px; margin-bottom:10px;">
      Email
      <input type="email" id="authEmail" placeholder="you@email.com" />
    </label>

    <label style="display:flex; flex-direction:column; gap:6px; margin-bottom:14px;">
      Password
      <input type="password" id="authPassword" placeholder="••••••••" />
    </label>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn btn-primary" id="loginBtn" type="button">Login</button>
      <button class="btn btn-outline" id="signupBtn" type="button">Sign up</button>
    </div>

    <p id="authMsg" style="margin-top:12px;"></p>
  </div>

  <!-- ✅ MAIN APP -->
  <div class="container" id="appContainer" style="display:none;">
    <!-- Top bar -->
    <div style="display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
      <span id="userEmail" style="opacity:.8; font-size:14px;"></span>
      <button class="btn btn-danger" id="logoutBtn" type="button">Log out</button>
    </div>

    <!-- DASHBOARD SUMMARY -->
    <div class="dashboard">
      <div class="dashboard-card">
        <div class="dash-label">Total jobs</div>
        <div class="dash-value" id="totalJobs">0</div>
      </div>
      <div class="dashboard-card">
        <div class="dash-label">Total profit (€)</div>
        <div class="dash-value" id="totalProfit">0.00</div>
      </div>
      <div class="dashboard-card">
        <div class="dash-label">Jobs this month</div>
        <div class="dash-value" id="jobsThisMonth">0</div>
      </div>
      <div class="dashboard-card">
        <div class="dash-label">Pending / In progress</div>
        <div class="dash-value" id="pendingJobs">0</div>
      </div>
    </div>

    <!-- FORM -->
    <form id="mixerForm">
      <label>
        Client Name
        <input type="text" id="clientName" required />
      </label>

      <label>
        Contact (phone/email)
        <input type="text" id="contact" />
      </label>

      <label>
        Nixer Model
        <input type="text" id="mixerModel" />
      </label>

      <label>
        Reg / Plate
        <input type="text" id="reg" />
      </label>

      <label>
        Parts Price (€)
        <input type="number" step="0.01" id="partsPrice" />
      </label>

      <label>
        Total Price (€)
        <input type="number" step="0.01" id="price" />
      </label>

      <label>
        Date
        <input type="date" id="date" />
      </label>

      <label>
        Status / Category
        <select id="status">
          <option value="Pending">Pending</option>
          <option value="In Progress">In Progress</option>
          <option value="Ready for Pickup">Ready for Pickup</option>
          <option value="Completed">Completed</option>
          <option value="Paid">Paid</option>
        </select>
      </label>

      <label class="full-width">
        Work Needed
        <textarea id="workNeeded"></textarea>
      </label>

      <label class="full-width">
        Notes / Work done
        <textarea id="notes"></textarea>
      </label>

      <button type="submit" id="addBtn" class="btn btn-primary">Add / Save</button>
    </form>

    <!-- CONTROLS -->
    <div class="actions">
      <input
        type="text"
        id="searchInput"
        placeholder="Search by client, reg, nixer, status..." />

      <div class="sort-controls">
        <span class="sort-label">Sort by:</span>
        <select id="sortBy">
          <option value="date">Date</option>
          <option value="client">Client name</option>
          <option value="price">Total price</option>
        </select>

        <button
          type="button"
          id="sortDirBtn"
          class="btn btn-small btn-outline"
          title="Toggle sort direction">
          ↓ Newest / Highest
        </button>
      </div>

      <div class="right-actions">
        <button id="installBtn" class="btn btn-primary" type="button" style="display:none;">
          Install App
        </button>

        <button id="hardRefreshBtn" class="btn btn-outline" type="button" title="Force reload latest version">
          Refresh App
        </button>

        <button id="themeToggle" type="button" class="btn btn-outline">Dark mode</button>
        <button id="downloadBtn" class="btn btn-outline" type="button">Download CSV</button>
        <button id="clearAllBtn" class="btn btn-danger" type="button">Clear ALL records</button>
      </div>
    </div>

    <!-- LEGEND -->
    <div class="legend">
      <span class="legend-item recent">Recent (≤ 7 days)</span>
      <span class="legend-item high">High value (€500+)</span>
      <span class="legend-item old">Very old (≥ 1 year)</span>
      <span class="legend-item done">Completed / Paid</span>
    </div>

    <!-- TABLE -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Client</th>
            <th>Contact</th>
            <th>Nixer</th>
            <th>Reg</th>
            <th>Status</th>
            <th>Date</th>
            <th>Parts (€)</th>
            <th>Total (€)</th>
            <th>Profit (€)</th>
            <th>Notes</th>
            <th>Work Needed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recordsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ✅ Update banner -->
  <div id="updateBanner" class="update-banner" style="display:none;">
    <div class="update-banner__inner">
      <div class="update-banner__text">
        <strong>Update available</strong> — tap refresh to get the latest version.
      </div>
      <div class="update-banner__actions">
        <button id="refreshAppBtn" class="btn btn-primary" type="button">Refresh</button>
        <button id="dismissUpdateBtn" class="btn btn-outline" type="button">Later</button>
      </div>
    </div>
  </div>

  <!-- ✅ Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // =========================
    // ✅ SUPABASE CONFIG (EDIT ME)
    // =========================
    const SUPABASE_URL = "https://GarageManagement.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_LwTSStYqTNdD8bmFwFDBpQ_h-r07Rdl"; 

    // IMPORTANT: use a unique variable name to avoid "already declared"
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // APP CONFIG
    // =========================
    const THEME_KEY = "mixer_theme_v1";

    const $ = (id) => document.getElementById(id);

    // Auth UI
    const authContainer = $("authContainer");
    const appContainer = $("appContainer");
    const authEmail = $("authEmail");
    const authPassword = $("authPassword");
    const loginBtn = $("loginBtn");
    const signupBtn = $("signupBtn");
    const logoutBtn = $("logoutBtn");
    const authMsg = $("authMsg");
    const userEmailEl = $("userEmail");

    // Form inputs
    const form = $("mixerForm");
    const clientNameInput = $("clientName");
    const contactInput = $("contact");
    const mixerModelInput = $("mixerModel");
    const regInput = $("reg");
    const partsPriceInput = $("partsPrice");
    const priceInput = $("price");
    const dateInput = $("date");
    const statusInput = $("status");
    const workNeededInput = $("workNeeded");
    const notesInput = $("notes");

    // UI elements
    const recordsBody = $("recordsBody");
    const searchInput = $("searchInput");
    const clearAllBtn = $("clearAllBtn");
    const addBtn = $("addBtn");
    const sortBySelect = $("sortBy");
    const sortDirBtn = $("sortDirBtn");
    const themeToggleBtn = $("themeToggle");
    const downloadBtn = $("downloadBtn");
    const installBtn = $("installBtn");
    const hardRefreshBtn = $("hardRefreshBtn");

    // Update banner elements
    const updateBanner = $("updateBanner");
    const refreshAppBtn = $("refreshAppBtn");
    const dismissUpdateBtn = $("dismissUpdateBtn");

    // Dashboard
    const totalJobsEl = $("totalJobs");
    const totalProfitEl = $("totalProfit");
    const jobsThisMonthEl = $("jobsThisMonth");
    const pendingJobsEl = $("pendingJobs");

    // State
    let records = [];
    let editId = null;
    let sortBy = "date";
    let sortDir = "desc";
    let deferredPrompt = null;

    // SW update state
    let newWorker = null;

    function setAuthMessage(msg, isError = false) {
      if (!authMsg) return;
      authMsg.textContent = msg;
      authMsg.style.color = isError ? "crimson" : "green";
    }

    function showApp(isLoggedIn) {
      if (authContainer) authContainer.style.display = isLoggedIn ? "none" : "block";
      if (appContainer) appContainer.style.display = isLoggedIn ? "block" : "none";
    }

    async function getSession() {
      const { data } = await supabaseClient.auth.getSession();
      return data.session;
    }

    async function refreshSessionUI() {
      const session = await getSession();
      showApp(!!session);

      if (userEmailEl) {
        userEmailEl.textContent = session?.user?.email ? `Logged in as ${session.user.email}` : "";
      }

      if (session) {
        await fetchRecords();
      } else {
        records = [];
        renderTable();
      }
      return session;
    }

    // =========================
    // DB CRUD
    // =========================
    function mapFormToDb() {
      const client_name = clientNameInput.value.trim();
      const contact = contactInput.value.trim();
      const nixer_model = mixerModelInput.value.trim();
      const reg = regInput.value.trim();
      const parts_price = partsPriceInput.value ? Number(partsPriceInput.value) : null;
      const total_price = priceInput.value ? Number(priceInput.value) : null;
      const job_date = dateInput.value || null;
      const status = statusInput.value || "Pending";
      const work_needed = workNeededInput.value.trim();
      const notes = notesInput.value.trim();

      return {
        client_name,
        contact,
        nixer_model,
        reg,
        parts_price,
        total_price,
        job_date,
        status,
        work_needed,
        notes,
        updated_at: new Date().toISOString()
      };
    }

    function clearForm() {
      form.reset();
      editId = null;
      statusInput.value = "Pending";
      addBtn.textContent = "Add / Save";
      addBtn.classList.remove("btn-editing");
    }

    async function fetchRecords() {
      const session = await getSession();
      if (!session) return;

      const { data, error } = await supabaseClient
        .from("records")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        alert("Error loading records: " + error.message);
        return;
      }

      records = data || [];
      renderTable();
    }

    async function insertRecord(dbRow) {
      const { data, error } = await supabaseClient
        .from("records")
        .insert([dbRow])
        .select("*")
        .single();

      if (error) throw error;
      return data;
    }

    async function updateRecord(id, dbRow) {
      const { data, error } = await supabaseClient
        .from("records")
        .update(dbRow)
        .eq("id", id)
        .select("*")
        .single();

      if (error) throw error;
      return data;
    }

    async function deleteRecord(id) {
      const { error } = await supabaseClient
        .from("records")
        .delete()
        .eq("id", id);

      if (error) throw error;
    }

    async function deleteAllMyRecords() {
      const { error } = await supabaseClient
        .from("records")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000");

      if (error) throw error;
    }

    // =========================
    // Sorting + Dashboard + Table
    // =========================
    function compareValues(a, b, field) {
      if (field === "client") {
        const x = (a.client_name || "").toLowerCase();
        const y = (b.client_name || "").toLowerCase();
        if (x < y) return -1;
        if (x > y) return 1;
        return 0;
      }

      if (field === "price") {
        const x = Number(a.total_price) || 0;
        const y = Number(b.total_price) || 0;
        return x - y;
      }

      const x = a.job_date ? new Date(a.job_date).getTime() : 0;
      const y = b.job_date ? new Date(b.job_date).getTime() : 0;
      return x - y;
    }

    function renderDashboard() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      let totalProfit = 0;
      let jobsThisMonth = 0;
      let pendingJobs = 0;

      records.forEach((r) => {
        const totalNum = Number(r.total_price) || 0;
        const partsNum = Number(r.parts_price) || 0;
        totalProfit += (totalNum - partsNum);

        if (r.job_date) {
          const d = new Date(r.job_date);
          if (!isNaN(d.getTime()) && d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
            jobsThisMonth++;
          }
        }

        const st = r.status || "Pending";
        if (st === "Pending" || st === "In Progress") pendingJobs++;
      });

      totalJobsEl.textContent = String(records.length);
      totalProfitEl.textContent = totalProfit.toFixed(2);
      jobsThisMonthEl.textContent = String(jobsThisMonth);
      pendingJobsEl.textContent = String(pendingJobs);
    }

    function renderTable() {
      const filter = (searchInput.value || "").trim().toLowerCase();
      recordsBody.innerHTML = "";

      const now = new Date();

      const data = [...records];
      data.sort((a, b) => {
        let result = compareValues(a, b, sortBy);
        if (sortDir === "desc") result = -result;
        return result;
      });

      data
        .filter((r) => {
          if (!filter) return true;
          return (
            (r.client_name || "").toLowerCase().includes(filter) ||
            (r.contact || "").toLowerCase().includes(filter) ||
            (r.nixer_model || "").toLowerCase().includes(filter) ||
            (r.reg || "").toLowerCase().includes(filter) ||
            (r.status || "").toLowerCase().includes(filter)
          );
        })
        .forEach((r) => {
          const tr = document.createElement("tr");

          const totalNum = Number(r.total_price) || 0;
          const partsNum = Number(r.parts_price) || 0;
          const profitNum = totalNum - partsNum;

          const rowClasses = [];
          if (r.job_date) {
            const d = new Date(r.job_date);
            if (!isNaN(d.getTime())) {
              const diffDays = (now - d) / (1000 * 60 * 60 * 24);
              if (diffDays <= 7) rowClasses.push("row-recent");
              else if (diffDays >= 365) rowClasses.push("row-old");
            }
          }
          if (totalNum >= 500) rowClasses.push("row-high-value");
          const st = r.status || "Pending";
          if (st === "Completed" || st === "Paid") rowClasses.push("row-completed");

          tr.className = rowClasses.join(" ");

          tr.innerHTML = `
            <td>${r.client_name || ""}</td>
            <td>${r.contact || ""}</td>
            <td>${r.nixer_model || ""}</td>
            <td>${r.reg || ""}</td>
            <td>${r.status || ""}</td>
            <td>${r.job_date || ""}</td>
            <td>${r.parts_price ?? ""}</td>
            <td>${r.total_price ?? ""}</td>
            <td>${isNaN(profitNum) ? "" : profitNum.toFixed(2)}</td>
            <td>${r.notes || ""}</td>
            <td>${r.work_needed || ""}</td>
            <td class="actions-cell">
              <button class="btn btn-small btn-outline" data-action="edit" data-id="${r.id}">Edit</button>
              <button class="btn btn-small btn-danger-outline" data-action="delete" data-id="${r.id}">Delete</button>
            </td>
          `;
          recordsBody.appendChild(tr);
        });

      renderDashboard();
    }

    // =========================
    // AUTH
    // =========================
    signupBtn.addEventListener("click", async () => {
      setAuthMessage("");
      const email = authEmail.value.trim();
      const password = authPassword.value;
      if (!email || !password) return setAuthMessage("Enter email + password.", true);

      const { error } = await supabaseClient.auth.signUp({ email, password });
      if (error) return setAuthMessage(error.message, true);

      setAuthMessage("Signed up! If confirmation is ON, check your email.");
      await refreshSessionUI();
    });

    loginBtn.addEventListener("click", async () => {
      setAuthMessage("");
      const email = authEmail.value.trim();
      const password = authPassword.value;
      if (!email || !password) return setAuthMessage("Enter email + password.", true);

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) return setAuthMessage(error.message, true);

      setAuthMessage("Logged in!");
      await refreshSessionUI();
    });

    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      setAuthMessage("Logged out.");
      await refreshSessionUI();
    });

    supabaseClient.auth.onAuthStateChange(() => {
      refreshSessionUI();
    });

    // =========================
    // EVENTS
    // =========================
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const dbRow = mapFormToDb();
      if (!dbRow.client_name) {
        alert("Client name is required.");
        return;
      }

      try {
        if (editId) await updateRecord(editId, dbRow);
        else await insertRecord(dbRow);

        clearForm();
        await fetchRecords();
      } catch (err) {
        console.error(err);
        alert("Save failed: " + (err?.message || err));
      }
    });

    recordsBody.addEventListener("click", async (e) => {
      const btn = e.target;
      if (!btn || btn.tagName !== "BUTTON") return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (!id) return;

      if (action === "delete") {
        if (!confirm("Delete this record?")) return;
        try {
          await deleteRecord(id);
          await fetchRecords();
        } catch (err) {
          console.error(err);
          alert("Delete failed: " + (err?.message || err));
        }
      }

      if (action === "edit") {
        const r = records.find((x) => x.id === id);
        if (!r) return;

        clientNameInput.value = r.client_name || "";
        contactInput.value = r.contact || "";
        mixerModelInput.value = r.nixer_model || "";
        regInput.value = r.reg || "";
        partsPriceInput.value = (r.parts_price ?? "") === null ? "" : String(r.parts_price ?? "");
        priceInput.value = (r.total_price ?? "") === null ? "" : String(r.total_price ?? "");
        dateInput.value = r.job_date || "";
        statusInput.value = r.status || "Pending";
        workNeededInput.value = r.work_needed || "";
        notesInput.value = r.notes || "";

        editId = id;
        addBtn.textContent = "Save changes";
        addBtn.classList.add("btn-editing");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    searchInput.addEventListener("input", renderTable);

    clearAllBtn.addEventListener("click", async () => {
      if (!confirm("This will delete ALL your records. Continue?")) return;
      try {
        await deleteAllMyRecords();
        await fetchRecords();
      } catch (err) {
        console.error(err);
        alert("Clear failed: " + (err?.message || err));
      }
    });

    sortBySelect.addEventListener("change", () => {
      sortBy = sortBySelect.value;
      renderTable();
    });

    sortDirBtn.addEventListener("click", () => {
      sortDir = sortDir === "asc" ? "desc" : "asc";
      sortDirBtn.textContent = sortDir === "asc" ? "↑ Oldest / Lowest" : "↓ Newest / Highest";
      renderTable();
    });

    // Theme
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark-mode");
        themeToggleBtn.textContent = "Light mode";
      } else {
        document.body.classList.remove("dark-mode");
        themeToggleBtn.textContent = "Dark mode";
      }
    }

    applyTheme(localStorage.getItem(THEME_KEY) || "light");

    themeToggleBtn.addEventListener("click", () => {
      const newTheme = document.body.classList.contains("dark-mode") ? "light" : "dark";
      localStorage.setItem(THEME_KEY, newTheme);
      applyTheme(newTheme);
    });

    // CSV
    downloadBtn.addEventListener("click", () => {
      if (!records.length) {
        alert("No records to download.");
        return;
      }

      const rows = [];
      rows.push([
        "Client","Contact","Nixer Model","Reg","Status","Date",
        "Parts Price (€)","Total Price (€)","Profit (€)","Notes","Work Needed"
      ].join(","));

      records.forEach((r) => {
        const totalNum = Number(r.total_price) || 0;
        const partsNum = Number(r.parts_price) || 0;
        const profit = totalNum - partsNum;

        rows.push([
          r.client_name || "",
          r.contact || "",
          r.nixer_model || "",
          r.reg || "",
          r.status || "",
          r.job_date || "",
          r.parts_price ?? "",
          r.total_price ?? "",
          profit.toFixed(2),
          (r.notes || "").replace(/,/g, ";"),
          (r.work_needed || "").replace(/,/g, ";")
        ].join(","));
      });

      const blob = new Blob([rows.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nixer-records.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Install (Android/Chrome)
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = "inline-flex";
    });

    installBtn.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      installBtn.style.display = "none";
      deferredPrompt = null;
    });

    // Hard refresh
    hardRefreshBtn.addEventListener("click", async () => {
      try {
        if ("serviceWorker" in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) await reg.update();
        }
      } catch {}

      try {
        if ("caches" in window) {
          const keys = await caches.keys();
          await Promise.all(keys.map((k) => caches.delete(k)));
        }
      } catch {}

      const url = new URL(window.location.href);
      url.searchParams.set("t", String(Date.now()));
      window.location.replace(url.toString());
    });

    // Init
    refreshSessionUI();
  </script>
</body>
</html>
